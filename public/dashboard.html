<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CleanSpot Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
            <span class="text-white text-xl font-bold">CS</span>
          </div>
          <h1 class="text-xl font-bold text-gray-900">CleanSpot Dashboard</h1>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-sm text-gray-600" id="portalInfo">Loading...</span>
          <button class="text-gray-600 hover:text-gray-900">Settings</button>
        </div>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 py-8">

    <!-- Success Message (se acabou de instalar) -->
    <div id="successMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
      <p class="text-green-800 font-semibold">âœ“ CleanSpot installed successfully!</p>
      <p class="text-green-700 text-sm mt-1">Click "Scan for Duplicates" to analyze your CRM.</p>
    </div>

    <!-- Health Score Card -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">CRM Health Score</h2>
      <div class="flex items-center space-x-6">
        <div class="flex-shrink-0">
          <div class="w-32 h-32 rounded-full border-8 flex items-center justify-center" id="healthCircle">
            <span class="text-4xl font-bold" id="healthScore">--</span>
          </div>
        </div>
        <div class="flex-1">
          <p class="text-lg mb-2">Status: <span class="font-semibold" id="healthStatus">Unknown</span></p>
          <p class="text-gray-600 text-sm" id="healthDescription">Run your first scan to see your CRM's health.</p>
          <button 
            onclick="scanDuplicates()"
            class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
            id="scanButton"
          >
            Scan for Duplicates
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow-sm p-4">
        <p class="text-gray-600 text-sm mb-1">Total Contacts</p>
        <p class="text-3xl font-bold" id="totalContacts">--</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-4">
        <p class="text-gray-600 text-sm mb-1">Duplicates Found</p>
        <p class="text-3xl font-bold text-red-600" id="duplicatesFound">--</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-4">
        <p class="text-gray-600 text-sm mb-1">Duplicates Merged</p>
        <p class="text-3xl font-bold text-green-600" id="duplicatesMerged">--</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-4">
        <p class="text-gray-600 text-sm mb-1">Last Scan</p>
        <p class="text-sm font-semibold" id="lastScan">Never</p>
      </div>
    </div>

    <!-- Scanning Progress (hidden initially) -->
    <div id="scanningProgress" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
      <div class="flex items-center space-x-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <div class="flex-1">
          <p class="font-semibold text-blue-900">Scanning your CRM...</p>
          <p class="text-sm text-blue-700" id="scanProgress">Fetching contacts...</p>
        </div>
      </div>
    </div>

    <!-- Duplicates List -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Duplicate Contacts</h2>
        <button 
          onclick="mergeSelected()"
          class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition disabled:opacity-50"
          id="mergeButton"
          disabled
        >
          Merge Selected
        </button>
      </div>
      
      <div id="duplicatesList">
        <p class="text-gray-500 text-center py-8">No duplicates found yet. Run a scan to detect duplicates.</p>
      </div>
    </div>

  </div>

  <script>
    // Pegar query params
    const urlParams = new URLSearchParams(window.location.search);
    const installed = urlParams.get('installed');
    const portalId = urlParams.get('portalId');

    // Mostrar success message se acabou de instalar
    if (installed === 'true') {
      document.getElementById('successMessage').classList.remove('hidden');
    }

    if (portalId) {
      document.getElementById('portalInfo').textContent = `Portal: ${portalId}`;
      loadDashboard(portalId);
    }

    // Carregar dados do dashboard
    async function loadDashboard(portalId) {
      try {
        const response = await fetch(`/api/dashboard?portalId=${portalId}`);
        const data = await response.json();

        if (data.success) {
          // Atualizar stats
          document.getElementById('totalContacts').textContent = data.stats.totalContacts.toLocaleString();
          document.getElementById('duplicatesFound').textContent = data.stats.duplicatesFound.toLocaleString();
          document.getElementById('duplicatesMerged').textContent = data.stats.duplicatesMerged.toLocaleString();
          
          // Atualizar health score
          const healthScore = data.healthScore.score;
          const healthStatus = data.healthScore.status;
          
          document.getElementById('healthScore').textContent = healthScore;
          document.getElementById('healthStatus').textContent = healthStatus.toUpperCase();
          
          // Colorir cÃ­rculo baseado no score
          const healthCircle = document.getElementById('healthCircle');
          if (healthScore >= 90) {
            healthCircle.className = 'w-32 h-32 rounded-full border-8 border-green-500 flex items-center justify-center';
          } else if (healthScore >= 75) {
            healthCircle.className = 'w-32 h-32 rounded-full border-8 border-blue-500 flex items-center justify-center';
          } else if (healthScore >= 60) {
            healthCircle.className = 'w-32 h-32 rounded-full border-8 border-yellow-500 flex items-center justify-center';
          } else {
            healthCircle.className = 'w-32 h-32 rounded-full border-8 border-red-500 flex items-center justify-center';
          }

          // Last scan
          if (data.lastScan) {
            const scanDate = new Date(data.lastScan);
            document.getElementById('lastScan').textContent = scanDate.toLocaleString();
          }
        }
      } catch (error) {
        console.error('Failed to load dashboard:', error);
      }
    }

    // Scan for duplicates
    async function scanDuplicates() {
      const scanButton = document.getElementById('scanButton');
      const scanProgress = document.getElementById('scanningProgress');
      
      scanButton.disabled = true;
      scanButton.textContent = 'Scanning...';
      scanProgress.classList.remove('hidden');

      try {
        // TODO: Pegar accessToken do storage ou da URL
        const accessToken = 'YOUR_ACCESS_TOKEN'; // TemporÃ¡rio

        const response = await fetch('/api/scan-duplicates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: accessToken,
            portalId: portalId
          })
        });

        const data = await response.json();

        if (data.success) {
          // Atualizar UI com resultados
          alert(`Scan complete! Found ${data.duplicates.length} duplicate pairs.`);
          
          // Recarregar dashboard
          loadDashboard(portalId);
          
          // Mostrar duplicates
          displayDuplicates(data.duplicates);
        }
      } catch (error) {
        console.error('Scan failed:', error);
        alert('Scan failed. Please try again.');
      } finally {
        scanButton.disabled = false;
        scanButton.textContent = 'Scan for Duplicates';
        scanProgress.classList.add('hidden');
      }
    }

    // Display duplicates in list
    function displayDuplicates(duplicates) {
      const list = document.getElementById('duplicatesList');
      
      if (duplicates.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-center py-8">No duplicates found! Your CRM is clean. ðŸŽ‰</p>';
        return;
      }

      let html = '<div class="space-y-4">';
      
      duplicates.forEach((dup, index) => {
        html += `
          <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
            <div class="flex items-start space-x-4">
              <input type="checkbox" class="mt-1 duplicate-checkbox" data-index="${index}">
              <div class="flex-1 grid md:grid-cols-2 gap-4">
                <div class="border-r pr-4">
                  <p class="font-semibold text-sm text-gray-600 mb-1">Contact A</p>
                  <p class="font-bold">${dup.contactA.name || 'No name'}</p>
                  <p class="text-sm text-gray-600">${dup.contactA.email || 'No email'}</p>
                  <p class="text-sm text-gray-600">${dup.contactA.phone || 'No phone'}</p>
                </div>
                <div>
                  <p class="font-semibold text-sm text-gray-600 mb-1">Contact B</p>
                  <p class="font-bold">${dup.contactB.name || 'No name'}</p>
                  <p class="text-sm text-gray-600">${dup.contactB.email || 'No email'}</p>
                  <p class="text-sm text-gray-600">${dup.contactB.phone || 'No phone'}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="inline-block bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded">
                  ${dup.confidenceScore}% match
                </span>
                <p class="text-xs text-gray-500 mt-1">${dup.matchReasons.join(', ')}</p>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      list.innerHTML = html;

      // Enable merge button when checkboxes selected
      document.querySelectorAll('.duplicate-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const anyChecked = document.querySelectorAll('.duplicate-checkbox:checked').length > 0;
          document.getElementById('mergeButton').disabled = !anyChecked;
        });
      });
    }

    // Merge selected duplicates
    function mergeSelected() {
      const selected = [];
      document.querySelectorAll('.duplicate-checkbox:checked').forEach(checkbox => {
        selected.push(parseInt(checkbox.dataset.index));
      });

      if (selected.length === 0) {
        alert('Please select duplicates to merge');
        return;
      }

      if (confirm(`Are you sure you want to merge ${selected.length} duplicate pair(s)?`)) {
        alert('Merge functionality coming soon!');
        // TODO: Implement merge API call
      }
    }
  </script>

</body>
</html>
